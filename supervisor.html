<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Supervisor — Dr. Charan Child Clinic</title>
  <link rel="manifest" href="./public/manifest.webmanifest">
  <link rel="icon" href="./public/assets/icon-192.png">
  <link rel="stylesheet" href="./styles/styles.css">
  <meta name="theme-color" content="#17B26A"/>
  <style>
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .krow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .badge{display:inline-flex;align-items:center;gap:.35rem;border:1px solid var(--ring);border-radius:999px;padding:.25rem .6rem;font-size:.8rem}
    .status{font-weight:700}
    .status.pending{color:var(--warn)}
    .status.approved{color:var(--accent)}
    .status.done{color:var(--ok)}
    .status.cancelled{color:var(--bad)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .toolbar .btn{padding:.45rem .7rem}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <!-- Banner -->
  <div class="hero-card">
    <img src="./public/assets/banner.png" alt="Dr. Charan Child Clinic">
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <button class="btn" id="themeBtn">Theme</button>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>

  <div class="app">
    <div class="page-card">
      <div class="toolbar" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <h2 style="margin:0 0 6px">Approvals</h2>
          <div class="small">Approve, mark Done, or Cancel today’s bookings.</div>
        </div>
        <div class="krow">
          <span class="pill">Date: <input id="day" type="date" class="in" style="width:12rem"></span>
          <input id="q" class="in" placeholder="Search (name / phone / PID)" style="width:16rem">
          <button class="btn" id="refreshBtn">Refresh</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="krow">
        <span class="badge">Pending: <strong id="kPending">0</strong></span>
        <span class="badge">Approved: <strong id="kApproved">0</strong></span>
        <span class="badge">Done: <strong id="kDone">0</strong></span>
      </div>
    </div>

    <div style="height:12px"></div>

    <!-- Table -->
    <div class="page-card">
      <h3 style="margin-top:0">Queue</h3>
      <table class="tbl" id="tblAppointments">
        <thead>
          <tr>
            <th>Time</th><th>Token</th><th>Name</th><th>Phone</th><th>Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
      <div id="emptyMsg" class="small muted" style="display:none">No records for the selected day.</div>
    </div>
  </div>

  <footer class="small">© 2025 Onestop Ai services. All rights Reserved</footer>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script>
    window.__SUPA = {
      url: "https://mngkgitmcudogekzmimv.supabase.co",
      key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1uZ2tnaXRtY3Vkb2dla3ptaW12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjc2NzcsImV4cCI6MjA3Mzk0MzY3N30.f0CAvjUyMM1qhuYTZwVw_9khQFIhglCmuE7GcYfuv1I"
    };
  </script>
  <script src="./scripts/cloud.js"></script>
  <script src="./scripts/sw-update.js"></script>

  <script type="module">
    import { cloud } from './scripts/cloud.js';

    const E=id=>document.getElementById(id);
    const todayISO=()=> new Date().toISOString().slice(0,10);
    E('day').value = todayISO();

    let filterText='';
    E('q').addEventListener('input',()=>{ filterText=E('q').value.toLowerCase(); render(); });
    E('refreshBtn').onclick = ()=> loadDay();
    E('day').addEventListener('change', loadDay);

    const rows=E('rows'), emptyMsg=E('emptyMsg');

    async function loadDay(){
      const date = E('day').value || todayISO();
      const { data:list } = await cloud.selectWhere('appointments',{ date });
      render(list||[]);
    }

    function render(list){
      rows.innerHTML='';
      const f=filterText;
      const items = (list||[]).filter(a=>{
        if(!f) return true;
        const hay=[a.name,a.phone,a.pid].map(x=>(x||'').toLowerCase()).join('|');
        return hay.includes(f);
      }).sort((a,b)=> (a.time||'').localeCompare(b.time||'') || (a.token||0)-(b.token||0));

      E('kPending').textContent=items.filter(a=>(a.status||'pending')==='pending').length;
      E('kApproved').textContent=items.filter(a=>a.status==='approved').length;
      E('kDone').textContent=items.filter(a=>a.status==='done').length;

      emptyMsg.style.display = items.length?'none':'';

      for(const a of items){
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class="mono">${a.time||''}</td>
          <td class="mono">${a.token||''}</td>
          <td>${a.name||''}<div class="small muted">${a.reason||''}</div></td>
          <td class="mono">${a.phone||''}</td>
          <td><span class="status ${(a.status||'pending')}">${a.status||'pending'}</span></td>
          <td class="row-actions">
            <button class="btn" data-act="approve">Approve</button>
            <button class="btn" data-act="done">Done</button>
            <button class="btn" data-act="cancel">Cancel</button>
          </td>
        `;
        tr.querySelector('[data-act="approve"]').onclick=()=>setStatus(a,'approved');
        tr.querySelector('[data-act="done"]').onclick=()=>setStatus(a,'done');
        tr.querySelector('[data-act="cancel"]').onclick=()=>setStatus(a,'cancelled');
        rows.appendChild(tr);
      }
    }

    async function setStatus(a,status){
      await cloud.update('appointments',a.id,{status});
      loadDay();
    }

    // Init
    await loadDay();

    // Realtime refresh
    cloud.listen('appointments',()=>loadDay());

    // Theme + logout
    const html=document.documentElement;
    html.setAttribute('data-theme',localStorage.getItem('theme')||'dark');
    E('themeBtn').onclick=()=>{
      const n=html.getAttribute('data-theme')==='dark'?'light':'dark';
      html.setAttribute('data-theme',n); localStorage.setItem('theme',n);
    };
    E('logoutBtn').onclick=()=>{ localStorage.removeItem('role'); location.href='./login.html'; };
  </script>
</body>
</html>
