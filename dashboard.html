<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Doctor Hub — Dr. Charan Child Clinic</title>
  <link rel="manifest" href="./public/manifest.webmanifest">
  <link rel="icon" href="./public/assets/icon-192.png">
  <link rel="stylesheet" href="./styles/styles.css">
  <meta name="theme-color" content="#17B26A"/>
  <style>
    /* charts row styling (local to this page) */
    .charts{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    @media (max-width:1100px){.charts{grid-template-columns:1fr}}
    .chart-card{background:var(--card);border:1px solid var(--ring);border-radius:var(--card-radius);box-shadow:var(--shadow);padding:12px}
    .chart-wrap{height:260px}
    .chart-wrap canvas{width:100%;height:100%}
  </style>
</head>
<body>
  <!-- Banner CARD (locked on all pages) -->
  <div class="hero-card">
    <img src="./public/assets/banner.png" alt="Dr. Charan Child Clinic">
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <button class="btn" id="themeBtn">Theme</button>
    <button class="btn" id="clearCacheBtn">Clear Cache</button>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>

  <div class="app">
    <div class="page-card">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
        <div>
          <h2 style="margin:0 0 6px">Doctor Hub</h2>
          <p class="small" style="margin:0">Daily tools & live KPIs</p>
        </div>
        <span class="pill">Today: <span id="todayStr"></span></span>
      </div>

      <!-- Charts row -->
      <div style="height:10px"></div>
      <div class="charts">
        <div class="chart-card">
          <div class="small" style="margin-bottom:6px">Sales (last 7 days)</div>
          <div class="chart-wrap"><canvas id="sales7Chart"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="small" style="margin-bottom:6px">Bookings (today) — by status</div>
          <div class="chart-wrap"><canvas id="bookingsPie"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="small" style="margin-bottom:6px">Revenue mix (7 days) — Lab vs Pharmacy</div>
          <div class="chart-wrap"><canvas id="mix7Chart"></canvas></div>
        </div>
      </div>

      <!-- 8 colorful tiles -->
      <div style="height:14px"></div>
      <div class="tiles">
        <a class="tile blue"   href="./analytics.html"><h3>Analytics</h3><div class="knum" id="kRev7">₹0</div></a>
        <a class="tile orange" href="./supervisor.html"><h3>Approvals</h3><div class="knum" id="kPending">0</div></a>
        <a class="tile green"  href="./patients-hub.html"><h3>Patients Hub</h3><div class="knum" id="kPatients">0</div></a>
        <a class="tile purple" href="./pharmacy.html"><h3>Pharmacy Hub</h3><div class="knum" id="kInv">0</div></a>
        <a class="tile pink"   href="./lab-orders.html"><h3>Lab</h3><div class="knum" id="kLab">0</div></a>
        <a class="tile orange" href="./staff.html"><h3>Staff</h3><div class="knum" id="kStaff">0</div></a>
        <a class="tile cyan"   href="./pharmacy-reports.html"><h3>Reports</h3><div class="knum" id="kReports">0</div></a>
        <a class="tile red"    href="./settings.html"><h3>Settings</h3><div class="knum">⚙</div></a>
      </div>

      <!-- Quick actions -->
      <div style="height:14px"></div>
      <div class="page-card" style="padding:12px">
        <h3 style="margin:0 0 8px">Quick Actions</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <a class="btn" href="./bookings.html">New Booking</a>
          <a class="btn" href="./patients-registry.html">New Patient</a>
          <a class="btn" href="./pharmacy-sales.html">New Sale</a>
          <a class="btn" href="./lab-orders.html">New Lab Order</a>
          <a class="btn" href="./booking-status.html">Booking Status Board</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="small">© 2025 Onestop Ai services. All rights Reserved</footer>

  <!-- Vendor -->
  <script src="./vendor/chart.min.js"></script>

  <!-- Supabase client + cloud adapter -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script>
    /* Provided keys (you can switch to Vercel env injection later) */
    window.__SUPA = {
      url: "https://mngkgitmcudogekzmimv.supabase.co",
      key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1uZ2tnaXRtY3Vkb2dla3ptaW12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjc2NzcsImV4cCI6MjA3Mzk0MzY3N30.f0CAvjUyMM1qhuYTZwVw_9khQFIhglCmuE7GcYfuv1I"
    };
  </script>
  <script src="./scripts/cloud.js"></script>
  <script src="./scripts/sw-update.js"></script>

  <!-- Dashboard logic (cloud-only) -->
  <script>
    const E = id => document.getElementById(id);
    const todayISO = () => new Date().toISOString().slice(0,10);
    const sum = (arr, sel) => (arr||[]).reduce((s,r)=>s+Number(sel(r)||0),0);

    // set date badge
    E('todayStr').textContent = todayISO();

    // ----- Theme / Topbar -----
    (function topbar(){
      const html=document.documentElement;
      const saved=localStorage.getItem('theme')||'dark';
      html.setAttribute('data-theme',saved);
      E('themeBtn').onclick=()=>{
        const n=html.getAttribute('data-theme')==='dark'?'light':'dark';
        html.setAttribute('data-theme',n); localStorage.setItem('theme',n);
      };
      E('logoutBtn').onclick=()=>{ localStorage.removeItem('role'); location.href='./login.html'; };
      E('clearCacheBtn').onclick=async()=>{
        if(!confirm('Clear caches + localStorage?')) return;
        if('caches' in window){ const names=await caches.keys(); for(const n of names) await caches.delete(n); }
        const keep=localStorage.getItem('theme'); localStorage.clear(); if(keep) localStorage.setItem('theme',keep);
        location.reload();
      };
    })();

    // ----- Colors for charts -----
    function tokenColors(){
      const root = getComputedStyle(document.documentElement);
      return {
        accent:  root.getPropertyValue('--accent').trim()   || '#1D75F0',
        accent2: root.getPropertyValue('--accent-2').trim() || '#EF2F87',
        ok:      root.getPropertyValue('--ok').trim()       || '#22c55e',
        warn:    root.getPropertyValue('--warn').trim()     || '#f59e0b',
        bad:     root.getPropertyValue('--bad').trim()      || '#ef4444'
      };
    }
    function safeChart(ctx, cfg){ try{ return new window.Chart(ctx, cfg); }catch(e){ console.error(e); return null; } }

    // ----- KPIs (cloud) -----
    async function refreshKPIs(){
      const d = todayISO();

      // Approvals: today's pending only
      const { data: apptsToday } = await cloud.selectWhere('appointments', { date:d });
      const list = apptsToday || [];
      E('kPending').textContent = list.filter(a => (a.status||'pending')==='pending').length;

      // Patients (total)
      const { data: pats } = await cloud.selectWhere('patients', {});
      E('kPatients').textContent = (pats||[]).length;

      // Pharmacy invoices (today)
      const { data: invToday } = await cloud.selectWhere('invoices', { date:d });
      E('kInv').textContent = (invToday||[]).length;

      // Lab (today)
      const { data: labToday } = await cloud.selectWhere('lab_invoices', { date:d });
      E('kLab').textContent = (labToday||[]).length;

      // Staff (total)
      const { data: staff } = await cloud.selectWhere('staff', {});
      E('kStaff').textContent = (staff||[]).length;

      // Reports KPI — proxy: last 7d invoice count
      const from7 = new Date(Date.now()-6*86400000).toISOString().slice(0,10);
      const days = listDays(from7, d);
      let inv7Count = 0, net7 = 0;
      for(const day of days){
        const { data: invd } = await cloud.selectWhere('invoices', { date:day });
        const arr = invd||[];
        inv7Count += arr.length;
        net7 += sum(arr.filter(i=>i.type==='sale'), r=>r.total) - sum(arr.filter(i=>i.type==='sale-return'), r=>r.total);
      }
      E('kReports').textContent = inv7Count;
      E('kRev7').textContent = '₹' + Number(net7||0).toFixed(2);
    }

    // ----- Helpers: date ranges -----
    function listDays(fromISO, toISO){
      const out=[]; const a=new Date(fromISO); const b=new Date(toISO);
      a.setHours(0,0,0,0); b.setHours(0,0,0,0);
      for(let d=new Date(a); d<=b; d.setDate(d.getDate()+1)){
        out.push(d.toISOString().slice(0,10));
      }
      return out;
    }

    // ----- Charts (cloud) -----
    let salesChart, bookingsPie, mixChart;

    async function buildSales7(){
      const today = new Date(); today.setHours(0,0,0,0);
      const first = new Date(today.getTime()-6*86400000).toISOString().slice(0,10);
      const last  = today.toISOString().slice(0,10);
      const days  = listDays(first, last);

      const totals = [];
      for(const day of days){
        const { data: invd } = await cloud.selectWhere('invoices', { date:day });
        const arr = invd || [];
        const net = sum(arr.filter(i=>i.type==='sale'), r=>r.total) - sum(arr.filter(i=>i.type==='sale-return'), r=>r.total);
        totals.push(net);
      }

      const {accent} = tokenColors();
      const ctx=document.getElementById('sales7Chart').getContext('2d');
      salesChart = safeChart(ctx,{
        type:'line',
        data:{labels:days,datasets:[{label:'Net Sales',data:totals,tension:.35,borderColor:accent,fill:false}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{grid:{color:'rgba(128,128,128,.2)'}}}}
      });
    }

    async function buildBookingsPie(){
      const d=todayISO();
      const { data: list } = await cloud.selectWhere('appointments', { date:d });
      const groups={pending:0, approved:0, done:0, cancelled:0};
      (list||[]).forEach(a=>{ const s=(a.status||'pending'); groups[s]=(groups[s]||0)+1; });
      const {ok,warn,bad,accent} = tokenColors();
      const ctx=document.getElementById('bookingsPie').getContext('2d');
      bookingsPie = safeChart(ctx,{
        type:'pie',
        data:{ labels:['Pending','Approved','Done','Cancelled'],
               datasets:[{ data:[groups.pending,groups.approved,groups.done,groups.cancelled],
                           backgroundColor:[warn,accent,ok,bad] }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}}
      });
    }

    async function buildMix7(){
      const today = new Date(); today.setHours(0,0,0,0);
      const first = new Date(today.getTime()-6*86400000).toISOString().slice(0,10);
      const last  = today.toISOString().slice(0,10);
      const days  = listDays(first, last);

      let pharm=0, lab=0;
      for(const day of days){
        const { data: invd } = await cloud.selectWhere('invoices', { date:day });
        pharm += sum((invd||[]).filter(i=>i.type==='sale'), r=>r.total) - sum((invd||[]).filter(i=>i.type==='sale-return'), r=>r.total);
        const { data: l } = await cloud.selectWhere('lab_invoices', { date:day });
        lab += sum(l||[], r=>r.amount);
      }

      const {accent,accent2} = tokenColors();
      const ctx=document.getElementById('mix7Chart').getContext('2d');
      mixChart = safeChart(ctx,{
        type:'doughnut',
        data:{ labels:['Pharmacy','Lab'], datasets:[{ data:[pharm,lab], backgroundColor:[accent,accent2]}]},
        options:{ responsive:true, maintainAspectRatio:false, cutout:'55%', plugins:{legend:{position:'bottom'}}}
      });
    }

    async function buildCharts(){
      await Promise.all([buildSales7(), buildBookingsPie(), buildMix7()]);
    }

    async function refreshAll(){
      await refreshKPIs();
      if(salesChart?.destroy) salesChart.destroy();
      if(bookingsPie?.destroy) bookingsPie.destroy();
      if(mixChart?.destroy) mixChart.destroy();
      await buildCharts();
    }

    // ----- Init -----
    (async ()=>{ await refreshAll(); })();

    // ----- Live updates via Supabase Realtime -----
    ;['appointments','invoices','lab_invoices'].forEach(t=>{
      cloud.listen(t, ()=>{ refreshAll(); });
    });

    // Also refresh when tab becomes visible
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) refreshAll(); });

    // Safety: periodic refresh
    setInterval(refreshAll, 30000);
  </script>

  <!-- Theme toggle (kept simple and global) -->
  <script>
    const html=document.documentElement;
    const saved=localStorage.getItem('theme')||'dark';
    html.setAttribute('data-theme',saved);
    document.getElementById('themeBtn')?.addEventListener('click',()=>{
      const n=html.getAttribute('data-theme')==='dark'?'light':'dark';
      html.setAttribute('data-theme',n); localStorage.setItem('theme',n);
      try{ window.dispatchEvent(new CustomEvent('theme:changed')); }catch{}
    });
  </script>
</body>
</html>
