<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bookings — Dr. Charan Child Clinic</title>
  <link rel="manifest" href="./public/manifest.webmanifest">
  <link rel="icon" href="./public/assets/icon-192.png">
  <link rel="stylesheet" href="./styles/styles.css">
  <meta name="theme-color" content="#17B26A"/>
  <style>
    .grid{display:grid;gap:10px}
    .grid.two{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.three{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.four{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width:900px){.grid.two,.grid.three,.grid.four{grid-template-columns:1fr}}
    .subtle{opacity:.85}
    .section-title{margin:0 0 6px}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .hint{opacity:.7;font-size:.85rem}
  </style>
</head>
<body>
  <!-- Banner -->
  <div class="hero-card">
    <img src="./public/assets/banner.png" alt="Dr. Charan Child Clinic">
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <button class="btn" id="themeBtn">Theme</button>
    <button class="btn" id="clearCacheBtn">Clear Cache</button>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>

  <div class="app">
    <div class="page-card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <div>
          <h2 style="margin:0 0 6px">Front Office Bookings</h2>
          <div class="small subtle">Generate slots, capture patient info, create bookings (pending), and send WhatsApp confirmations.</div>
        </div>
        <span class="pill">Today: <span id="todayStr"></span></span>
      </div>

      <!-- DATE -->
      <div style="height:10px"></div>
      <div class="grid two">
        <label>Date
          <input type="date" id="dateInput" class="in"/>
        </label>
        <div>
          <div class="small subtle" style="margin-bottom:6px">Quick</div>
          <div class="inline">
            <button class="btn" id="loadTodayBtn">Load Today</button>
          </div>
        </div>
      </div>

      <!-- SLOT GENERATOR -->
      <div style="height:14px"></div>
      <h3 class="section-title">Generate Custom Time Slots</h3>
      <div class="small subtle" style="margin:0 0 8px">Configure AM/PM windows & interval (mins). Generates fresh slots for selected date.</div>

      <div class="grid three">
        <div class="card">
          <div class="small subtle">Morning window</div>
          <div class="grid three">
            <label>Start <input id="amStart" class="in" type="time" value="09:00"></label>
            <label>End <input id="amEnd" class="in" type="time" value="12:00"></label>
            <label>Interval <input id="amStep" class="in" type="number" min="5" step="5" value="30"></label>
          </div>
        </div>
        <div class="card">
          <div class="small subtle">Afternoon window</div>
          <div class="grid three">
            <label>Start <input id="pmStart" class="in" type="time" value="14:00"></label>
            <label>End <input id="pmEnd" class="in" type="time" value="17:00"></label>
            <label>Interval <input id="pmStep" class="in" type="number" min="5" step="5" value="30"></label>
          </div>
        </div>
        <div class="card">
          <div class="small subtle">Actions</div>
          <div class="grid two">
            <button class="btn primary" id="genSlotsBtn">Generate Slots</button>
            <button class="btn" id="reloadSlotsBtn">Reload Slots</button>
          </div>
          <div class="small subtle" id="slotCount" style="margin-top:8px">0 slots</div>
        </div>
      </div>

      <!-- BOOKING FORM -->
      <div style="height:14px"></div>
      <h3 class="section-title">Assign Booking</h3>

      <div class="grid two">
        <label>Available Slot
          <select id="slotSelect" class="sel"></select>
        </label>
        <label>Source
          <div class="inline">
            <select id="source" class="sel">
              <option value="walk-in">Walk-in</option>
              <option value="online">Online</option>
              <option value="whatsapp">WhatsApp</option>
            </select>
            <button class="btn" id="waBtn" style="display:none">WhatsApp</button>
          </div>
        </label>
      </div>

      <div class="grid four" style="margin-top:8px">
        <label>PID <input id="pid" class="in" placeholder="Pxxx"></label>
        <label>Child Name *<input id="name" class="in" required></label>
        <label>Phone <input id="phone" class="in"></label>
        <label>Parent <input id="parent" class="in"></label>
      </div>
      <div class="grid four" style="margin-top:8px">
        <label>DOB <input id="dob" class="in" type="date"></label>
        <label>Age <input id="age" class="in" disabled></label>
        <label>Height <input id="height" class="in" type="number"></label>
        <label>Weight <input id="weight" class="in" type="number"></label>
      </div>
      <div class="grid two" style="margin-top:8px">
        <label>Reason <input id="reason" class="in"></label>
        <div style="align-self:end"><button class="btn primary" id="saveBtn">Save Booking</button></div>
      </div>

      <!-- TODAY BOOKINGS -->
      <div style="height:18px"></div>
      <h3 class="section-title">Bookings for selected day</h3>
      <table class="tbl">
        <thead><tr><th>Token</th><th>Time</th><th>PID</th><th>Name</th><th>Phone</th><th>Source</th><th>Status</th></tr></thead>
        <tbody id="todayTable"></tbody>
      </table>
    </div>
  </div>

  <footer class="small">© 2025 Onestop Ai services. All rights Reserved</footer>

  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script>
    window.__SUPA = {
      url: "https://mngkgitmcudogekzmimv.supabase.co",
      key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1uZ2tnaXRtY3Vkb2dla3ptaW12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjc2NzcsImV4cCI6MjA3Mzk0MzY3N30.f0CAvjUyMM1qhuYTZwVw_9khQFIhglCmuE7GcYfuv1I"
    };
  </script>
  <script src="./scripts/cloud.js"></script>

  <script>
    const E = id=>document.getElementById(id);
    const todayISO = ()=>new Date().toISOString().slice(0,10);
    const pad = n=>String(n).padStart(2,'0');
    const to12h = t=>{const[h,m]=t.split(':').map(Number);const am=h>=12?'PM':'AM';return `${(h%12)||12}:${pad(m)} ${am}`;};
    const onlyDigits=s=>(s||'').replace(/\D+/g,'');
    const enc=s=>encodeURIComponent(s);

    E('todayStr').textContent=todayISO();E('dateInput').value=todayISO();
    E('dob').onchange=()=>{if(E('dob').value){const d=new Date(E('dob').value);const n=new Date();let y=n.getFullYear()-d.getFullYear();if(n<n.setFullYear(d.getFullYear()+y))y--;E('age').value=y;}};

    function updateWA(){E('waBtn').style.display=E('source').value==='whatsapp'?'inline-flex':'none';}
    E('source').onchange=updateWA;updateWA();

    function buildWindowSlots(date,start,end,step){const out=[];if(!start||!end||!step)return out;let t=start;while(t<end){out.push({date,time:to12h(t)});const[h,m]=t.split(':').map(Number);const mins=h*60+m+Number(step);t=`${pad(Math.floor(mins/60))}:${pad(mins%60)}`;}return out;}

    async function generateSlots(date){
      const am=buildWindowSlots(date,E('amStart').value,E('amEnd').value,E('amStep').value);
      const pm=buildWindowSlots(date,E('pmStart').value,E('pmEnd').value,E('pmStep').value);
      let token=1;const slots=[...am,...pm].map((s,i)=>({...s,token:token+i,status:'free'}));
      // wipe old slots
      await cloud.del('slots',{date});
      for(const s of slots){await cloud.insert('slots',s);}
      await loadSlots(date);
    }

    async function loadSlots(date){
      const taken=await cloud.selectWhere('appointments',{date});
      const bookedTokens=new Set((taken.data||[]).map(r=>r.token));
      const {data}=await cloud.selectWhere('slots',{date});
      const free=(data||[]).filter(s=>!bookedTokens.has(s.token));
      E('slotSelect').innerHTML=free.map(s=>`<option value="${s.token}">${s.time} (#${s.token})</option>`).join('');
      E('slotCount').textContent=`${(data||[]).length} slots (${free.length} free)`;
    }

    async function loadBookings(date){
      const {data}=await cloud.selectWhere('appointments',{date});
      data.sort((a,b)=>(a.token||0)-(b.token||0));
      E('todayTable').innerHTML=(data||[]).map(a=>`<tr><td>${a.token}</td><td>${a.time}</td><td>${a.pid}</td><td>${a.name}</td><td>${a.phone}</td><td>${a.source}</td><td>${a.status}</td></tr>`).join('');
    }

    function waLink({phone,name,date,time,token,reason,pid}){
      const p=onlyDigits(phone);if(!p)return null;
      const msg=`Hello ${name||'there'},%0AYour booking is noted.%0ADate: ${date}%0ATime: ${time} (Token #${token})%0APID: ${pid||''}%0AReason: ${reason||''}%0A— Thank you`;
      return `https://wa.me/${p}?text=${msg}`;
    }

    E('waBtn').onclick=()=>{
      const t=E('slotSelect').selectedOptions[0]?.textContent||'';
      const link=waLink({phone:E('phone').value,name:E('name').value,date:E('dateInput').value,time:t,token:E('slotSelect').value,reason:E('reason').value,pid:E('pid').value});
      if(link) window.open(link,'_blank');
    };

    async function saveBooking(){
      const date=E('dateInput').value||todayISO();
      const token=Number(E('slotSelect').value);
      if(!token){alert('Pick slot');return;}
      const time=E('slotSelect').selectedOptions[0].textContent.split(' (#')[0];
      const pid=E('pid').value||'P'+Date.now().toString().slice(-6);
      const row={date,time,token,pid,name:E('name').value,phone:E('phone').value,parent:E('parent').value,dob:E('dob').value,height:E('height').value,weight:E('weight').value,source:E('source').value,reason:E('reason').value,status:'pending'};
      await cloud.upsert('patients',{pid,name:row.name,phone:row.phone,parent:row.parent,dob:row.dob,heightcm:row.height,weightkg:row.weight},'pid');
      await cloud.upsert('appointments',row,'date,token');
      await cloud.insert('patienthistory',{pid,date,note:`Booking ${time} token#${token}`,author:'Front Office',meta:{}});
      await loadSlots(date);await loadBookings(date);
      if(row.source==='whatsapp'){const link=waLink(row);if(link&&confirm('Open WhatsApp?'))window.open(link,'_blank');}
      alert('Saved booking.');
    }

    E('genSlotsBtn').onclick=()=>generateSlots(E('dateInput').value);
    E('reloadSlotsBtn').onclick=()=>{loadSlots(E('dateInput').value);loadBookings(E('dateInput').value);};
    E('loadTodayBtn').onclick=()=>{E('dateInput').value=todayISO();loadSlots(todayISO());loadBookings(todayISO());};
    E('saveBtn').onclick=saveBooking;
    E('dateInput').onchange=()=>{loadSlots(E('dateInput').value);loadBookings(E('dateInput').value);};

    (async()=>{const d=todayISO();await loadSlots(d);await loadBookings(d);})();

    (function topbar(){
      const html=document.documentElement;
      const saved=localStorage.getItem('theme')||'dark';html.setAttribute('data-theme',saved);
      E('themeBtn').onclick=()=>{const n=html.getAttribute('data-theme')==='dark'?'light':'dark';html.setAttribute('data-theme',n);localStorage.setItem('theme',n);};
      E('logoutBtn').onclick=()=>{localStorage.removeItem('role');location.href='./login.html';};
      E('clearCacheBtn').onclick=()=>{localStorage.clear();location.reload();};
    })();
  </script>
</body>
</html>
