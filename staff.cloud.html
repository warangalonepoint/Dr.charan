<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Staff — Dr. Charan Child Clinic (Cloud)</title>
  <link rel="manifest" href="./public/manifest.webmanifest">
  <link rel="icon" href="./public/assets/icon-192.png">
  <link rel="stylesheet" href="./styles/styles.css">
  <meta name="theme-color" content="#17B26A"/>
  <style>
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
    .list{max-height:520px;overflow:auto}
    .row{padding:.6rem;border-bottom:1px solid var(--ring);display:flex;justify-content:space-between;gap:10px;align-items:center}
    .row:hover{background:rgba(255,255,255,.04)}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .pill.ok{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.35)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  </style>
</head>
<body>
  <!-- Banner -->
  <div class="hero-card">
    <img src="./public/assets/banner.png" alt="Dr. Charan Child Clinic">
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <button class="btn" id="themeBtn">Theme</button>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>

  <div class="app">
    <div class="page-card">
      <div class="toolbar" style="justify-content:space-between">
        <div>
          <h2 style="margin:0 0 6px">Staff (Cloud)</h2>
          <div class="small muted">Backed by Supabase — live shared data.</div>
        </div>
        <span class="pill ok">Online</span>
      </div>

      <div class="grid" style="margin-top:10px">
        <!-- Form -->
        <div class="page-card">
          <h3 style="margin-top:0">Add / Update Staff</h3>
          <div class="grid" style="grid-template-columns:1fr 1fr">
            <div>
              <label class="small">Name*</label>
              <input id="name" class="in" placeholder="Full name">
            </div>
            <div>
              <label class="small">Role*</label>
              <select id="role" class="in sel">
                <option value="doctor">doctor</option>
                <option value="supervisor">supervisor</option>
                <option value="frontoffice">frontoffice</option>
                <option value="pharmacist">pharmacist</option>
                <option value="lab">lab</option>
              </select>
            </div>
            <div>
              <label class="small">Phone*</label>
              <input id="phone" class="in mono" placeholder="10-digit">
            </div>
            <div>
              <label class="small">ID (for edit)</label>
              <input id="sid" class="in mono" placeholder="Auto / UUID" disabled>
            </div>
          </div>
          <div style="height:8px"></div>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn" id="newBtn">New</button>
            <button class="btn primary" id="saveBtn">Save</button>
          </div>
          <div class="small muted" id="msg" style="margin-top:8px"></div>
        </div>

        <!-- List -->
        <div class="page-card">
          <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
            <h3 style="margin-top:0">Staff List</h3>
            <input id="q" class="in" placeholder="Search (name / phone / role)" style="max-width:260px">
          </div>
          <div class="list" id="list"></div>
        </div>
      </div>
    </div>
  </div>

  <footer class="small">© 2025 Onestop Ai services. All rights Reserved</footer>

  <!-- Supabase JS (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.1/dist/supabase.min.js"></script>

  <script type="module">
    // ---------- THEME ----------
    const html=document.documentElement, saved=localStorage.getItem('theme')||'dark';
    html.setAttribute('data-theme',saved);
    document.getElementById('themeBtn').onclick=()=>{const n=html.getAttribute('data-theme')==='dark'?'light':'dark'; html.setAttribute('data-theme',n); localStorage.setItem('theme',n);};
    document.getElementById('logoutBtn').onclick=()=>{ localStorage.removeItem('role'); location.href='./login.html'; };

    // ---------- SUPABASE CLIENT ----------
    const SUPABASE_URL = "https://mngkgitmcudogekzmimv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1uZ2tnaXRtY3Vkb2dla3ptaW12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNjc2NzcsImV4cCI6MjA3Mzk0MzY3N30.f0CAvjUyMM1qhuYTZwVw_9khQFIhglCmuE7GcYfuv1I";

    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------- UI refs ----------
    const E=id=>document.getElementById(id);
    const list=E('list'), q=E('q'), msg=E('msg');

    function getForm(){
      return {
        id: (E('sid').value||'').trim() || null,
        name: (E('name').value||'').trim(),
        role: E('role').value,
        phone: (E('phone').value||'').trim()
      };
    }
    function setForm(r){
      E('sid').value=r?.id||'';
      E('name').value=r?.name||'';
      E('role').value=r?.role||'doctor';
      E('phone').value=r?.phone||'';
    }
    E('newBtn').onclick=()=>{ setForm({}); msg.textContent=''; };

    async function load(){
      const term=(q.value||'').trim().toLowerCase();
      let { data, error } = await client.from('staff').select('*').order('name', { ascending: true });
      if(error){ console.error(error); msg.textContent='Load failed: '+error.message; return; }
      let rows = data || [];
      if(term){
        rows = rows.filter(r=>{
          const hay=[r.name,r.phone,r.role].map(x=>(x||'').toLowerCase()).join('|');
          return hay.includes(term);
        });
      }
      list.innerHTML='';
      rows.forEach(r=>{
        const div=document.createElement('div'); div.className='row';
        div.innerHTML = `
          <div>
            <strong>${r.name||''}</strong> <span class="muted">(${r.role||''})</span>
            <div class="small mono">${r.phone||''}</div>
          </div>
          <div style="display:flex;gap:6px">
            <button class="btn" data-act="edit">Edit</button>
            <button class="btn" data-act="del" style="background:var(--bad);color:#fff;border:0">Delete</button>
          </div>
        `;
        div.querySelector('[data-act="edit"]').onclick=()=> setForm(r);
        div.querySelector('[data-act="del"]').onclick=async()=>{
          if(!confirm('Delete this staff?')) return;
          const { error:delErr } = await client.from('staff').delete().eq('id', r.id);
          if(delErr){ alert('Delete failed: '+delErr.message); return; }
          await load();
        };
        list.appendChild(div);
      });
    }
    q.addEventListener('input', load);

    async function save(){
      msg.textContent='';
      const f=getForm();
      if(!f.name || !f.role || !f.phone){ msg.textContent='Name, role, phone are required.'; return; }

      if(f.id){
        const { error } = await client.from('staff')
          .update({ name:f.name, role:f.role, phone:f.phone })
          .eq('id', f.id);
        if(error){ msg.textContent='Update failed: '+error.message; return; }
        msg.textContent='Updated.';
      }else{
        // Upsert by phone (optional) to avoid duplicates
        const { error } = await client.from('staff')
          .upsert([{ name:f.name, role:f.role, phone:f.phone }], { onConflict: 'phone' });
        if(error){ msg.textContent='Insert failed: '+error.message; return; }
        msg.textContent='Saved.';
      }
      setForm({});
      await load();
    }
    E('saveBtn').onclick=save;

    await load();
  </script>
</body>
</html>
