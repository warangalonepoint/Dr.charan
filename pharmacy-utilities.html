<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pharmacy Utilities — Dr. Charan Child Clinic</title>
  <link rel="manifest" href="./public/manifest.webmanifest">
  <link rel="icon" href="./public/assets/icon-192.png">
  <link rel="stylesheet" href="./styles/styles.css">
  <meta name="theme-color" content="#17B26A"/>
</head>
<body>
  <!-- Banner -->
  <div class="hero-card"><img src="./public/assets/banner.png" alt="Dr. Charan Child Clinic"></div>

  <!-- Topbar -->
  <div class="topbar">
    <button class="btn" id="themeBtn">Theme</button>
    <button class="btn" id="clearCacheBtn">Clear Cache</button>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>

  <div class="app">
    <div class="page-card">
      <h2>Pharmacy Utilities</h2>
      <p class="small">Manage stock adjustments, expiry/write-off, and testing seed/clear for pharmacy only.</p>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
        <button class="btn" id="seedPharmBtn">Seed Pharmacy Data</button>
        <button class="btn" id="clearPharmBtn" style="background:var(--bad);color:#fff;border:0">Clear Pharmacy Data</button>
      </div>

      <!-- Stock Adjust -->
      <h3>Stock Adjustment</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0">
        <input class="in" id="adjSku" placeholder="SKU (e.g. SEED-PARA-250)">
        <input class="in" id="adjQty" type="number" placeholder="Quantity ±">
        <button class="btn primary" id="adjBtn">Adjust</button>
      </div>

      <!-- Expiry / Write-off -->
      <h3>Mark Expiry / Write-off</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0">
        <input class="in" id="expSku" placeholder="SKU">
        <input class="in" id="expQty" type="number" placeholder="Quantity">
        <input class="in" id="expReason" placeholder="Reason (e.g., expired, damaged)">
        <button class="btn primary" id="expBtn">Write-off</button>
      </div>

      <div class="small" id="msg" style="opacity:.85"></div>
    </div>
  </div>

  <footer class="small">© 2025 Onestop Ai services. All rights Reserved</footer>

  <!-- Dexie + global seeder (attaches window.seedPharmacyData / window.clearPharmacyData) -->
  <script src="https://cdn.jsdelivr.net/npm/dexie@4/dist/dexie.min.js"></script>
  <script src="./scripts/pharmacy-seed.js"></script>

  <!-- App wiring -->
  <script type="module">
    import db from './scripts/db.js';
    import { emitClinicChange } from './scripts/data-wire.js';

    // ---- Topbar / theme / housekeeping ----
    const html=document.documentElement;
    html.setAttribute('data-theme',localStorage.getItem('theme')||'dark');
    document.getElementById('themeBtn').onclick=()=>{
      const n=html.getAttribute('data-theme')==='dark'?'light':'dark';
      html.setAttribute('data-theme',n); localStorage.setItem('theme',n);
    };
    document.getElementById('logoutBtn').onclick=()=>{ localStorage.removeItem('role'); location.href='./login.html'; };
    document.getElementById('clearCacheBtn').onclick=async()=>{
      if(!confirm('Clear caches + local DB?')) return;
      if('caches' in window){ const names=await caches.keys(); for(const n of names) await caches.delete(n); }
      await db.delete();
      const keep=localStorage.getItem('theme'); localStorage.clear(); if(keep) localStorage.setItem('theme',keep);
      location.reload();
    };

    const E = id => document.getElementById(id);
    const msg = E('msg');
    const todayISO = () => new Date().toISOString().slice(0,10);

    function say(text){ msg.textContent=text; setTimeout(()=>{ msg.textContent=''; }, 1800); }

    // ---- Seed / Clear (from pharmacy-seed.js globals) ----
    E('seedPharmBtn').onclick = async ()=>{
      try{
        if(typeof window.seedPharmacyData!=='function'){ alert('seedPharmacyData() not found'); return; }
        E('seedPharmBtn').disabled=true; E('seedPharmBtn').textContent='Seeding…';
        await window.seedPharmacyData();
        emitClinicChange('import:done',{scope:'pharmacy'});
        alert('Pharmacy data seeded.');
      }catch(err){
        console.error(err); alert('Seeding failed: '+(err?.message||err));
      }finally{
        E('seedPharmBtn').disabled=false; E('seedPharmBtn').textContent='Seed Pharmacy Data';
      }
    };

    E('clearPharmBtn').onclick = async ()=>{
      try{
        if(typeof window.clearPharmacyData!=='function'){ alert('clearPharmacyData() not found'); return; }
        if(!confirm('Clear pharmacy items, invoices, invoiceItems & related?')) return;
        E('clearPharmBtn').disabled=true; E('clearPharmBtn').textContent='Clearing…';
        await window.clearPharmacyData();
        emitClinicChange('pharmacy:cleared',{});
        alert('Pharmacy data cleared.');
      }catch(err){
        console.error(err); alert('Clear failed: '+(err?.message||err));
      }finally{
        E('clearPharmBtn').disabled=false; E('clearPharmBtn').textContent='Clear Pharmacy Data';
      }
    };

    // ---- Stock adjustment (+/-) ----
    E('adjBtn').onclick = async ()=>{
      const sku=(E('adjSku').value||'').trim();
      const qty = Number(E('adjQty').value||0);
      if(!sku || !qty){ alert('Enter SKU and non-zero quantity'); return; }

      const it = await db.pharmacyItems.where('sku').equals(sku).first();
      if(!it){ alert('Item not found: '+sku); return; }

      const newStock = Number(it.stock||0) + qty;
      await db.pharmacyItems.update(it.id, { stock:newStock });

      // Optional accounting journal in vouchers (zero-amount note)
      await db.vouchers.add({
        date: todayISO(),
        type: 'journal',
        amount: 0,
        party: 'stock-adjust',
        note: `SKU:${sku} • NAME:${it.name||''} • DELTA:${qty} • NEW:${newStock}`
      });

      emitClinicChange('pharmacy:inventory',{sku,delta:qty});
      say(`Adjusted ${sku} by ${qty}. New stock=${newStock}`);
      E('adjQty').value='';
    };

    // ---- Expiry / write-off (↓ stock, journal entry) ----
    E('expBtn').onclick = async ()=>{
      const sku=(E('expSku').value||'').trim();
      const qty = Math.max(1, Number(E('expQty').value||0));
      const reason=(E('expReason').value||'').trim() || 'expired';
      if(!sku || !qty){ alert('Enter SKU and quantity'); return; }

      const it = await db.pharmacyItems.where('sku').equals(sku).first();
      if(!it){ alert('Item not found: '+sku); return; }

      const cur = Number(it.stock||0);
      if(qty>cur){ alert('Qty exceeds current stock'); return; }

      const newStock = cur - qty;
      await db.pharmacyItems.update(it.id, { stock:newStock });

      // Log as zero-amount voucher (party='expiry') — aligns with pharmacy-expiry.html
      await db.vouchers.add({
        date: todayISO(),
        type: 'journal',
        amount: 0,
        party: 'expiry',
        note: `SKU:${sku} • NAME:${it.name||''} • QTY:${qty} • REASON:${reason}`
      });

      emitClinicChange('pharmacy:inventory',{sku,qty});
      say(`Write-off: ${qty} of ${sku}. Stock now=${newStock}`);
      ['expSku','expQty','expReason'].forEach(id=>E(id).value='');
    };
  </script>
</body>
</html>
