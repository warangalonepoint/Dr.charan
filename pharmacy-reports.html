<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pharmacy Reports — Dr. Charan Child Clinic</title>
  <link rel="manifest" href="./public/manifest.webmanifest">
  <link rel="icon" href="./public/assets/icon-192.png">
  <link rel="stylesheet" href="./styles/styles.css">
  <meta name="theme-color" content="#17B26A"/>
  <style>
    .tbl{width:100%;border-collapse:collapse}
    .tbl th,.tbl td{padding:.5rem;border-bottom:1px solid var(--ring);text-align:left}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    tfoot td{font-weight:bold;border-top:2px solid var(--ring)}
    @media print {
      .topbar,.controls,footer{display:none}
      body{background:#fff;color:#000}
      .page-card{box-shadow:none}
    }
  </style>
</head>
<body>
  <!-- Banner -->
  <div class="hero-card"><img src="./public/assets/banner.png" alt="Dr. Charan Child Clinic"></div>

  <!-- Topbar -->
  <div class="topbar">
    <button class="btn" id="themeBtn">Theme</button>
    <button class="btn" id="clearCacheBtn">Clear Cache</button>
    <button class="btn" id="logoutBtn">Logout</button>
  </div>

  <div class="app">
    <div class="page-card">
      <h2 style="margin:0 0 6px">Pharmacy — Reports</h2>
      <div class="controls">
        <input id="from" type="date" class="in mono">
        <input id="to" type="date" class="in mono">
        <select id="type" class="in sel">
          <option value="">All Types</option>
          <option>sale</option>
          <option>purchase</option>
          <option>sale-return</option>
          <option>purchase-return</option>
        </select>
        <button class="btn" id="filterBtn">Filter</button>
        <button class="btn" id="csvBtn">Export CSV</button>
        <button class="btn" id="printBtn">Print</button>
      </div>
      <table class="tbl">
        <thead>
          <tr><th>Date</th><th>Type</th><th>Party</th><th>Total</th></tr>
        </thead>
        <tbody id="rows"></tbody>
        <tfoot>
          <tr><td colspan="3">Net Sales</td><td id="netSales">₹0.00</td></tr>
          <tr><td colspan="3">Net Purchases</td><td id="netPurch">₹0.00</td></tr>
          <tr><td colspan="3">Net Returns</td><td id="netReturns">₹0.00</td></tr>
          <tr><td colspan="3">Grand Total</td><td id="grandTotal">₹0.00</td></tr>
        </tfoot>
      </table>
    </div>
  </div>

  <footer class="small">© 2025 Onestop Ai services. All rights Reserved</footer>

  <!-- Vendor -->
  <script src="https://cdn.jsdelivr.net/npm/dexie@4/dist/dexie.min.js"></script>
  <!-- App -->
  <script type="module">
    import db from './scripts/db.js';

    // Topbar
    const html=document.documentElement,saved=localStorage.getItem('theme')||'dark';
    html.setAttribute('data-theme',saved);
    themeBtn.onclick=()=>{const n=html.getAttribute('data-theme')==='dark'?'light':'dark';html.setAttribute('data-theme',n);localStorage.setItem('theme',n)};
    logoutBtn.onclick=()=>{localStorage.removeItem('role');location.href='./login.html'};
    clearCacheBtn.onclick=async()=>{if(!confirm('Clear caches + DB?'))return;if('caches'in window){const ns=await caches.keys();for(const n of ns)await caches.delete(n)}localStorage.clear();location.reload()};

    // Elements
    const E=id=>document.getElementById(id), rows=E('rows');
    const netSales=E('netSales'), netPurch=E('netPurch'), netReturns=E('netReturns'), grandTotal=E('grandTotal');
    const today=()=>new Date().toISOString().slice(0,10);
    from.value=to.value=today();

    async function load(){
      let list=await db.invoices.toArray();
      if(from.value) list=list.filter(x=>(x.date||'')>=from.value);
      if(to.value) list=list.filter(x=>(x.date||'')<=to.value);
      if(type.value) list=list.filter(x=>x.type===type.value);
      list.sort((a,b)=>(b.date||'').localeCompare(a.date||''));
      rows.innerHTML=list.map(x=>`<tr><td>${x.date}</td><td>${x.type}</td><td>${x.party||''}</td><td>₹${(x.total||0).toFixed(2)}</td></tr>`).join('');

      // Totals
      let sales=0,purch=0,returns=0,grand=0;
      list.forEach(x=>{
        const t=Number(x.total||0);
        if(x.type==='sale') sales+=t;
        else if(x.type==='purchase') purch+=t;
        else if(x.type.includes('return')) returns+=t;
        grand+= (x.type==='sale'||x.type==='sale-return'? t : -t); // net calc
      });
      netSales.textContent='₹'+sales.toFixed(2);
      netPurch.textContent='₹'+purch.toFixed(2);
      netReturns.textContent='₹'+returns.toFixed(2);
      grandTotal.textContent='₹'+grand.toFixed(2);
      return list;
    }

    filterBtn.onclick=load;
    csvBtn.onclick=async()=>{
      const list=await load();
      let csv='Date,Type,Party,Total\n';
      list.forEach(x=>{csv+=`${x.date},${x.type},${x.party||''},${x.total}\n`});
      csv+=`\nNet Sales,${sales},\nNet Purchases,${purch},\nNet Returns,${returns},\nGrand Total,${grand}\n`;
      const blob=new Blob([csv],{type:'text/csv'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='pharmacy_reports.csv';a.click();
    };
    printBtn.onclick=()=>{window.print()};

    load();
  </script>
</body>
</html>
